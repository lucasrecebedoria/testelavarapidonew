
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Comparativo Semanal</title>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="left">
      <img src="assets/logo.png"/>
      <a class="btn" href="app.html">Voltar</a>
    </div>
  </header>
  <main class="container">
    <div class="card">
      <h2>Comparativo de lavagens por semana</h2>
      <div class="controls">
        <label>Semanas atr√°s</label>
        <input id="semanas" type="number" min="1" value="6" class="input" style="max-width:140px"/>
      </div>
      <canvas id="chartSemanas"></canvas>
    </div>
  </main>
  <footer class="footer">Developed by Lucas L Custodio, V1</footer>
  <script type="module">
    import { auth, db, requireAuth } from './js/firebase.js';
    import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    await requireAuth();
    const $=(q)=>document.querySelector(q);
    function rangeWeeks(n){
      const arr=[]; const now=new Date();
      for(let i=n-1;i>=0;i--){
        const end = new Date(now); end.setDate(end.getDate()- (end.getDay()+6)%7 ); // last Monday midnight
        end.setDate(end.getDate()-i*7);
        const start = new Date(end); start.setDate(start.getDate()-6);
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        arr.push({start, end, label: start.toLocaleDateString('pt-BR')+' - '+end.toLocaleDateString('pt-BR')});
      }
      return arr;
    }
    async function load(){
      const n=parseInt($('#semanas').value,10);
      const weeks=rangeWeeks(n);
      const counts=[];
      for(const w of weeks){
        const qy=query(collection(db,'lavagens'), where('createdAt','>=', w.start), where('createdAt','<=', w.end));
        const snap=await getDocs(qy);
        counts.push(snap.size);
      }
      render(weeks.map(w=>w.label), counts);
    }
    function render(labels, data){
      const ctx=document.getElementById('chartSemanas');
      if(window._chartS) window._chartS.destroy();
      window._chartS = new Chart(ctx,{type:'bar', data:{labels, datasets:[{label:'Lavagens/semana', data, borderWidth:1}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
    }
    document.getElementById('semanas').addEventListener('change', load);
    load();
  </script>
</body>
</html>
