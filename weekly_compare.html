<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Comparativo Semanal</title>
  <link rel="icon" href="icon.ico"><link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.9.0/pptxgen.bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <div class="logo-left"><img src="logo.png" class="logo"><div class="title">Comparativo Semanal</div></div>
  <div class="top-actions"><a href="app.html"><button class="steel">Voltar</button></a></div>
  <div class="right-box">
    <div class="export-wrap">
      <button class="export-btn steel">Exportar</button>
      <div class="export-menu">
        <button id="pptSemCmp">Exportar PowerPoint</button>
        <button id="excelSemCmp">Salvar Excel</button>
      </div>
    </div>
  </div>
</header>
<div class="container">
  <div id="resumoNumerico" class="card steel">
    <h3>Resumo da semana</h3>
    <div class="scroll-x">
      <table id="tblResumoSem" class="table">
        <thead><tr><th>Tipo</th><th>Qtd</th><th>Total</th><th>Média por dia</th></tr></thead>
        <tbody><tr><td>-</td><td>-</td><td>-</td><td>-</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Escolher data dentro da semana</label>
        <input type="date" id="startDate">
      </div>
    </div>
    <div class="scroll-x">
      <canvas id="cmpChart" height="150"></canvas>
    </div>
  </div>
</div>
<div class="footer">Developed by Lucas L Custodio, V1</div>

<script type="module">
import { db, collection, getDocs, query, where } from "./scripts/firebase.js";
import { weekRangeFrom, downloadFileName } from "./scripts/common.js";

const ctx = document.getElementById('cmpChart').getContext('2d');
let chart;
document.getElementById('startDate').value = new Date().toISOString().slice(0,10);

async function loadWeek(){
  const d = new Date(document.getElementById('startDate').value);
  const [ini,fim] = weekRangeFrom(d);
  const q = query(collection(db,"relatorios"), where("data",">=",ini), where("data","<=",fim));
  const snap = await getDocs(q);
  let s=0,h=0,e=0;
  for(const d of snap.docs){
    const t = d.data().tipo;
    if(t==="Lavagem Simples") s++; else if(t==="Higienização") h++; else e++;
  }
  const total = s+h+e;
  const media = (total/7).toFixed(1);
  const tbody = document.querySelector("#tblResumoSem tbody");
  tbody.innerHTML = `<tr><td>Simples | Hig | Exc</td><td>${s} | ${h} | ${e}</td><td>${total}</td><td>${media}</td></tr>`;

  const data = { labels:["Lavagem Simples","Higienização","Exceções"], datasets:[{label:"Semana", data:[s,h,e]}]};
  if(chart) chart.destroy();
  chart = new Chart(ctx, {type:"bar", data, options:{scales:{y:{beginAtZero:true}}}});
}
document.getElementById('startDate').addEventListener('change', loadWeek);
await loadWeek();

document.getElementById('pptSemCmp').onclick = ()=>{
  const pptx = new PptxGenJS();
  let slide = pptx.addSlide();
  slide.addText("Comparativo Semanal", {x:0.5,y:0.3,fontSize:22,bold:true});
  const cvs = document.getElementById('cmpChart');
  slide.addImage({ data:cvs.toDataURL("image/png"), x:0.5,y:1,w:9,h:4.5 });
  const rows = [...document.querySelectorAll("#tblResumoSem tr")].map(tr=>[...tr.children].map(td=>td.innerText));
  slide.addTable(rows, {x:0.5,y:5.7,w:9});
  pptx.writeFile(downloadFileName('semanal')+".pptx");
};
document.getElementById('excelSemCmp').onclick = ()=>{
  const tbl = document.getElementById("tblResumoSem");
  const wb = XLSX.utils.table_to_book(tbl,{sheet:"ResumoSemanal"});
  XLSX.writeFile(wb, downloadFileName('semanal')+".xlsx");
};
</script>
</body>
</html>
