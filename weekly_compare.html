<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Comparativo Semanal</title>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header class="header">
  <img src="assets/logo.png"/>
  <div class="spacer"></div>
  <a class="btn" href="app.html">Voltar</a>
</header>
<main class="container">
  <div class="card">
    <div class="controls">
      <h2 style="margin-right:auto">Comparativo de lavagens por semana</h2>
      <input id="semanas" type="number" class="input" min="2" value="6" style="max-width:140px"/>
    </div>
    <canvas id="chart"></canvas>
  </div>
</main>
<footer class="footer">Developed by Lucas L Custodio, V1</footer>
<script type="module">
  import { db, requireAuth } from './js/firebase.js';
  import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  await requireAuth();
  const $=(q)=>document.querySelector(q);
  function weekBlock(weeksAgo){
    const now=new Date(); const end=new Date(now);
    const dow=(end.getDay()+6)%7; end.setDate(end.getDate()-dow - 7*weeksAgo); end.setHours(23,59,59,999);
    const start=new Date(end); start.setDate(end.getDate()-6); start.setHours(0,0,0,0);
    return {start,end,label: start.toLocaleDateString('pt-BR')+' - '+end.toLocaleDateString('pt-BR')};
  }
  async function load(){
    const n=parseInt($('#semanas').value,10);
    const labels=[]; const values=[];
    for(let i=n-1;i>=0;i--){
      const w=weekBlock(i); labels.push(w.label);
      const qy=query(collection(db,'lavagens'), where('createdAt','>=',w.start), where('createdAt','<=',w.end));
      const snap=await getDocs(qy); values.push(snap.size);
    }
    if(window._chart) window._chart.destroy();
    window._chart=new Chart(document.getElementById('chart'),{type:'bar',data:{labels,datasets:[{label:'Lavagens/semana',data:values,borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }
  document.getElementById('semanas').addEventListener('change', load);
  load();
</script>
</body>
</html>