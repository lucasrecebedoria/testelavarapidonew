<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MOVE BUSS - Lan√ßamentos</title>
  <link rel="icon" href="icon.ico">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.9.0/pptxgen.bundle.js"></script>
</head>
<body>
<header>
  <div class="logo-left">
    <img src="logo.png" class="logo">
    <div class="title">Lan√ßamentos & Relat√≥rio Semanal</div>
  </div>
  <div class="top-actions">
    <a href="monthly.html"><button class="badge badge-prata">Relat√≥rio mensal</button></a>
    <a href="monthly_chart.html"><button class="steel">Abrir gr√°fico mensal</button></a>
    <a href="weekly_compare.html"><button class="steel">Comparativo semanal</button></a>
    <a href="productivity.html"><button class="steel">Produtividade</button></a>
  </div>
  <div class="right-box top-actions">
    <button id="changePassBtn" class="steel">Alterar senha</button>
    <button id="logoutBtn" class="metal">Logout</button>
  </div>
</header>
<div class="container">
  <div class="card">
    <div class="toolbar">
      <h3>Novo lan√ßamento</h3>
      <div class="kpis">
        <div class="kpi"><div class="label">M√™s - Simples</div><div class="value" id="kpiSimples">0</div></div>
        <div class="kpi"><div class="label">M√™s - Higieniza√ß√£o</div><div class="value" id="kpiHig">0</div></div>
        <div class="kpi"><div class="label">M√™s - Exce√ß√µes</div><div class="value" id="kpiExc">0</div></div>
        <div class="kpi"><div class="label">Total M√™s</div><div class="value" id="kpiTotal">0</div></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Prefixo</label>
        <div style="display:flex;gap:6px">
          <span class="badge">55</span>
          <input id="prefixo" placeholder="001, 002, ..." style="flex:1">
        </div>
      </div>
      <div class="col">
        <label>Tipo de lavagem</label>
        <select id="tipoLavagem">
          <option>Lavagem Simples</option>
          <option>Higieniza√ß√£o</option>
          <option>Exce√ß√µes</option>
        </select>
      </div>
      <div class="col">
        <label>Data</label>
        <input id="data" type="date">
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="saveBtn" class="metal">Salvar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div style="display:flex;align-items:center;gap:10px">
        <button id="toggleLow" class="collapsible steel">Prefixos &lt; 2 lavagens (minimizado)</button>
      </div>
      <div class="export-wrap">
        <button class="export-btn steel">Exportar</button>
        <div class="export-menu">
          <button id="pdfSemanal">Salvar PDF</button>
          <button id="excelSemanal">Salvar Excel</button>
          <button id="pptSemanal">Exportar PowerPoint</button>
        </div>
      </div>
    </div>

    <div id="lowPanel" class="hidden">
      <div class="scroll-x" style="max-height:160px; overflow-y:auto">
        <div id="lowList" class="row"></div>
      </div>
      <p class="small">Somente administradores podem excluir prefixos deste painel.</p>
    </div>

    <div class="row" style="margin:10px 0">
      <div class="col"><label>Filtro prefixo</label><input id="filtroPrefixo"></div>
      <div class="col"><label>Filtro quantidade</label><input id="filtroQtd" type="number" min="0" placeholder="ex: &gt;= 2"></div>
    </div>

    <table class="table" id="tabelaSemanal">
      <thead><tr><th>Prefixo</th><th>Tipo</th><th>Data</th><th>Hora</th><th>Usu√°rio</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="footer">Developed by Lucas L Custodio, V1</div>

<script type="module">
import { requireAuth, doLogout, changePassword, prefixBadge, tipoBadge, horaBadge, weekRangeFrom, monthRangeFrom, brDate, brDateInputValue, downloadFileName, getMatriculaFromEmail } from "./scripts/common.js";
import { db, auth, collection, addDoc, query, where, orderBy, getDocs, doc, deleteDoc, serverTimestamp } from "./scripts/firebase.js";

const user = await requireAuth();
document.getElementById('logoutBtn').addEventListener('click', doLogout);
document.getElementById('changePassBtn').addEventListener('click', changePassword);

document.getElementById('data').value = brDateInputValue(new Date());

// Salvar lan√ßamento
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const pref = Number('55'+ document.getElementById('prefixo').value.padStart(3,'0'));
  const tipo = document.getElementById('tipoLavagem').value;
  const data = new Date(document.getElementById('data').value);
  if(!pref || !data){ alert("Preencha os campos."); return; }
  try{
    await addDoc(collection(db,"relatorios"), {
      prefixo: pref,
      tipo,
      data: data,
      criadoEm: serverTimestamp(),
      usuario: user.email
    });
    // limpar campos ap√≥s salvar
    document.getElementById('prefixo').value = '';
    document.getElementById('tipoLavagem').selectedIndex = 0;
    document.getElementById('data').value = brDateInputValue(new Date());
    document.getElementById('prefixo').focus();
    await loadWeek();
    await loadMonthKpis();
    alert("Lan√ßamento salvo!");
  }catch(e){ alert("Erro ao salvar: "+e.message); }
});

// Painel & filtros
document.getElementById('toggleLow').addEventListener('click', ()=>{
  document.getElementById('lowPanel').classList.toggle('hidden');
});

document.getElementById('pdfSemanal').addEventListener('click', ()=>exportPDF('tabelaSemanal','semanal'));
document.getElementById('excelSemanal').addEventListener('click', ()=>exportExcel('tabelaSemanal','semanal'));
document.getElementById('pptSemanal').addEventListener('click', ()=>exportPPT('tabelaSemanal','Relat√≥rio Semanal'));

function exportExcel(tableId, tipo){
  const t = document.getElementById(tableId);
  const wb = XLSX.utils.table_to_book(t,{sheet:"Semanal"});
  XLSX.writeFile(wb, downloadFileName(tipo)+".xlsx");
}
async function exportPDF(tableId, tipo){
  const { jsPDF } = window.jspdf;
  const docPdf = new jsPDF('l','pt','a4');
  docPdf.text("Relat√≥rio Semanal", 40, 40);
  const t = document.getElementById(tableId);
  const rows = [...t.querySelectorAll('tr')].map(tr => [...tr.children].map(td=>td.innerText));
  let y=70;
  rows.forEach(r=>{ docPdf.text(r.join(" | "), 40, y); y+=18; if(y>530){ docPdf.addPage(); y=40; }});
  docPdf.save(downloadFileName(tipo)+".pdf");
}
function exportPPT(tableId, title){
  const pptx = new PptxGenJS();
  let slide = pptx.addSlide();
  slide.addText(title, {x:0.5,y:0.3,fontSize:20,bold:true});
  const t = document.getElementById(tableId);
  const rows = [...t.querySelectorAll('tr')].map(tr => [...tr.children].map(td=>td.innerText));
  slide.addTable(rows, {x:0.5,y:1,w:9});
  pptx.writeFile(downloadFileName('semanal')+".pptx");
}

// Carregar semanal
async function loadWeek(){
  const [ini,fim] = (function(){
    const now = new Date();
    const day = now.getDay();
    const diffToMon = (day===0? -6 : 1 - day);
    const start = new Date(now); start.setDate(now.getDate()+diffToMon); start.setHours(0,0,0,0);
    const end = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
    return [start,end];
  })();

  const q = query(collection(db,"relatorios"),
                  where("data",">=",ini), where("data","<=",fim),
                  orderBy("data","desc"));
  const snap = await getDocs(q);
  const tbody = document.querySelector("#tabelaSemanal tbody");
  tbody.innerHTML = "";
  const counts = {};
  for(const d of snap.docs){
    const r = d.data();
    counts[r.prefixo] = (counts[r.prefixo]||0)+1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${prefixBadge(r.prefixo)}</td>
      <td>${tipoBadge(r.tipo)}</td>
      <td>${brDate(r.data.toDate ? r.data.toDate() : r.data)}</td>
      <td>${horaBadge(r.criadoEm?.toDate ? r.criadoEm.toDate() : new Date())}</td>
      <td>${getMatriculaFromEmail(r.usuario)}</td>
      <td><button class="steel" data-id="${d.id}" style="padding:6px 10px"><span style="color:#ff6b6b">üóë</span></button></td>
    `;
    tr.querySelector('button').addEventListener('click', async (ev)=>{
      // apenas admin pode excluir
      const matricula = getMatriculaFromEmail(user.email);
      if(!["12","6266","1778"].includes(matricula)){ alert("Somente admin."); return; }
      await deleteDoc(doc(db,"relatorios", ev.currentTarget.dataset.id));
      await loadWeek();
    });
    tbody.appendChild(tr);
  }

  // montar painel < 2 lavagens
  const low = [];
  for(let i=1;i<=559;i++){ low.push(55000 + i); }
  for(let i=900;i<=1000;i++){ low.push(55000 + i); }
  const less = low.filter(p => (counts[p]||0) < 2);
  const list = document.getElementById('lowList');
  list.innerHTML="";
  less.forEach(p=>{
    const div = document.createElement('div');
    div.className="badge steel";
    div.style.margin="4px";
    div.innerHTML = prefixBadge(p);
    list.appendChild(div);
  });

  // filtros
  document.getElementById('filtroPrefixo').oninput = ()=>{
    const v = document.getElementById('filtroPrefixo').value.trim();
    [...tbody.children].forEach(tr=>{
      const ok = tr.children[0].innerText.includes(v);
      tr.style.display = ok? "" : "none";
    });
  };
  document.getElementById('filtroQtd').oninput = ()=>{
    const n = Number(document.getElementById('filtroQtd').value||0);
    // apenas visual, n√£o altera dados. (Mantido simples)
  };
}

async function loadMonthKpis(){
  const [ini,fim] = (function(){
    const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(),1);
    const end = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);
    return [start,end];
  })();
  const q = query(collection(db,"relatorios"), where("data",">=",ini), where("data","<=",fim));
  const snap = await getDocs(q);
  let s=0,h=0,e=0;
  for(const d of snap.docs){
    const t = d.data().tipo;
    if(t==="Lavagem Simples") s++; else if(t==="Higieniza√ß√£o") h++; else e++;
  }
  document.getElementById('kpiSimples').innerText = s;
  document.getElementById('kpiHig').innerText = h;
  document.getElementById('kpiExc').innerText = e;
  document.getElementById('kpiTotal').innerText = s+h+e;
}

await loadWeek();
await loadMonthKpis();
</script>
</body>
</html>
