<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gráfico Mensal</title>
  <link rel="icon" href="icon.ico"><link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.9.0/pptxgen.bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <div class="logo-left"><img src="logo.png" class="logo"><div class="title">Gráfico Mensal</div></div>
  <div class="top-actions"><a href="monthly.html"><button class="steel">Voltar</button></a></div>
  <div class="right-box">
    <div class="export-wrap">
      <button class="export-btn steel">Exportar</button>
      <div class="export-menu">
        <button id="pptMensalGraf">Exportar PowerPoint</button>
        <button id="excelMensalGraf">Salvar Excel</button>
      </div>
    </div>
  </div>
</header>
<div class="container">
  <div id="resumoNumerico" class="card steel">
    <h3>Resumo do mês</h3>
    <div class="scroll-x">
      <table id="tblResumoMensal" class="table">
        <thead><tr><th>Tipo</th><th>Quantidade</th><th>Prefixos distintos</th><th>Total</th></tr></thead>
        <tbody><tr><td>-</td><td>-</td><td>-</td><td>-</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col"><label>Mês</label><input type="month" id="mes"></div>
    </div>
    <div class="scroll-x">
      <canvas id="monthlyChart" height="140"></canvas>
    </div>
  </div>
</div>
<div class="footer">Developed by Lucas L Custodio, V1</div>

<script type="module">
import { db, collection, getDocs, query, where } from "./scripts/firebase.js";
import { monthRangeFrom, downloadFileName } from "./scripts/common.js";

const ctx = document.getElementById('monthlyChart').getContext('2d');
let chart;
document.getElementById('mes').value = new Date().toISOString().slice(0,7);

async function loadMonth(){
  const ym = document.getElementById('mes').value;
  const [y,m] = ym.split('-').map(Number);
  const start = new Date(y, m-1, 1);
  const end = new Date(y, m, 0, 23,59,59,999);
  const q = query(collection(db,"relatorios"), where("data",">=",start), where("data","<=",end));
  const snap = await getDocs(q);
  let s=0,h=0,e=0; const prefixSet = new Set();
  for(const d of snap.docs){
    const r = d.data();
    prefixSet.add(r.prefixo);
    if(r.tipo==="Lavagem Simples") s++; else if(r.tipo==="Higienização") h++; else e++;
  }
  // resumo
  const total = s+h+e;
  const tbody = document.querySelector("#tblResumoMensal tbody");
  tbody.innerHTML = `<tr><td>Simples | Hig | Exc</td><td>${s} | ${h} | ${e}</td><td>${prefixSet.size}</td><td>${total}</td></tr>`;

  // gráfico
  const data = {
    labels: ["Lavagem Simples","Higienização","Exceções"],
    datasets: [{ label:"Qtd no mês", data:[s,h,e] }]
  };
  if(chart) chart.destroy();
  chart = new Chart(ctx, {type:"bar", data,
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, elements:{ bar:{ borderWidth:1 } } }
  });
}

document.getElementById('mes').addEventListener('change', loadMonth);
await loadMonth();

// export
document.getElementById('pptMensalGraf').onclick = ()=>{
  const pptx = new PptxGenJS();
  let slide = pptx.addSlide();
  slide.addText("Gráfico Mensal", {x:0.5,y:0.3,fontSize:20,bold:true});
  const canvas = document.getElementById("monthlyChart");
  slide.addImage({ data: canvas.toDataURL("image/png"), x:0.5,y:1,w:9,h:4.5 });
  // também inclui tabela resumo
  const rows = [...document.querySelectorAll("#tblResumoMensal tr")].map(tr=>[...tr.children].map(td=>td.innerText));
  slide.addTable(rows, {x:0.5,y:5.7,w:9});
  pptx.writeFile(downloadFileName('mensal')+".pptx");
};
document.getElementById('excelMensalGraf').onclick = ()=>{
  const tbl = document.getElementById("tblResumoMensal");
  const wb = XLSX.utils.table_to_book(tbl,{sheet:"ResumoMensal"});
  XLSX.writeFile(wb, downloadFileName('mensal')+".xlsx");
};
</script>
</body>
</html>
