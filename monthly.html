<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Relatório Mensal</title>
  <link rel="icon" href="icon.ico">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.9.0/pptxgen.bundle.js"></script>
</head>
<body>
<header>
  <div class="logo-left">
    <img src="logo.png" class="logo">
    <div class="title">Relatório Mensal</div>
  </div>
  <div class="top-actions">
    <a href="app.html"><button class="steel">Voltar</button></a>
    <a href="monthly_chart.html"><button class="steel">Abrir gráfico mensal</button></a>
  </div>
  <div class="right-box">
    <div class="export-wrap">
      <button class="export-btn steel">Exportar</button>
      <div class="export-menu">
        <button id="pdfMensal">Salvar PDF</button>
        <button id="excelMensal">Salvar Excel</button>
        <button id="pptMensal">Exportar PowerPoint</button>
      </div>
    </div>
  </div>
</header>
<div class="container">
  <div class="card">
    <div class="row">
      <div class="col"><label>Filtro por prefixo</label><input id="filtroPrefixo"></div>
      <div class="col"><label>Mês</label><input type="month" id="mes"></div>
    </div>
    <table class="table" id="tabelaMensal">
      <thead><tr><th>Prefixo</th><th>Qtd no mês</th><th>Dias</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div class="footer">Developed by Lucas L Custodio, V1</div>

<script type="module">
import { db, collection, getDocs, query, where, orderBy } from "./scripts/firebase.js";
import { prefixBadge, monthRangeFrom, brDate, downloadFileName } from "./scripts/common.js";

document.getElementById('mes').value = new Date().toISOString().slice(0,7);

async function loadMonth(){
  const ym = document.getElementById('mes').value;
  const [y,m] = ym.split('-').map(Number);
  const start = new Date(y, m-1, 1);
  const end = new Date(y, m, 0, 23,59,59,999);
  const q = query(collection(db,"relatorios"), where("data",">=",start), where("data","<=",end));
  const snap = await getDocs(q);
  const map = new Map();
  for(const d of snap.docs){
    const r = d.data();
    const key = r.prefixo;
    if(!map.has(key)) map.set(key, {count:0, dias: new Set()});
    const v = map.get(key);
    v.count++;
    const dt = r.data.toDate ? r.data.toDate() : r.data;
    v.dias.add(brDate(dt));
  }
  const tbody = document.querySelector('#tabelaMensal tbody');
  tbody.innerHTML = "";
  [...map.entries()].sort((a,b)=>a[0]-b[0]).forEach(([p,info])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${prefixBadge(p)}</td><td>${info.count}</td><td>${[...info.dias].join(", ")}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('filtroPrefixo').oninput = ()=>{
    const v = document.getElementById('filtroPrefixo').value.trim();
    [...tbody.children].forEach(tr=> tr.style.display = tr.children[0].innerText.includes(v) ? "" : "none");
  };
}
function exportExcel(){
  const t = document.getElementById('tabelaMensal');
  const wb = XLSX.utils.table_to_book(t,{sheet:"Mensal"});
  XLSX.writeFile(wb, downloadFileName('mensal')+".xlsx");
}
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const docPdf = new jsPDF('l','pt','a4');
  docPdf.text("Relatório Mensal", 40, 40);
  const t = document.getElementById('tabelaMensal');
  const rows = [...t.querySelectorAll('tr')].map(tr => [...tr.children].map(td=>td.innerText));
  let y=70; rows.forEach(r=>{ docPdf.text(r.join(" | "), 40, y); y+=18; if(y>530){ docPdf.addPage(); y=40; }});
  docPdf.save(downloadFileName('mensal')+".pdf");
}
function exportPPT(){
  const pptx = new PptxGenJS();
  let slide = pptx.addSlide();
  slide.addText("Relatório Mensal", {x:0.5,y:0.3,fontSize:22,bold:true});
  const t = document.getElementById('tabelaMensal');
  const rows = [...t.querySelectorAll('tr')].map(tr => [...tr.children].map(td=>td.innerText));
  slide.addTable(rows, {x:0.5,y:1,w:9});
  pptx.writeFile(downloadFileName('mensal')+".pptx");
}
document.getElementById('pdfMensal').onclick = exportPDF;
document.getElementById('excelMensal').onclick = exportExcel;
document.getElementById('pptMensal').onclick = exportPPT;
document.getElementById('mes').addEventListener('change', loadMonth);
await loadMonth();
</script>
</body>
</html>
