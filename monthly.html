<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Relatório Mensal</title>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header class="header">
  <img src="assets/logo.png"/>
  <div class="spacer"></div>
  <a class="btn" href="app.html">Voltar</a>
  <button id="btnPDF" class="btn">Salvar PDF</button>
  <button id="btnExcelMensal" class="btn silver">Salvar Excel</button>
</header>
<main class="container">
  <div class="card" id="mensalBox">
    <div class="controls">
      <h2 style="margin-right:auto">Relatório Mensal</h2>
      <input id="mes" type="month" class="input"/>
      <input id="filtroPrefixo" class="input" placeholder="Filtrar prefixo (ex.: 55001)" style="max-width:240px"/>
      <button id="btnGraficoMensal" class="btn">Abrir gráfico mensal</button>
    </div>
    <div class="scroll">
      <table class="table" id="tabMensal">
        <thead><tr><th>Prefixo</th><th>Qtd no mês</th><th>Dias lavados</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3>Gráfico por prefixo</h3>
  </div>
</main>
<footer class="footer">Developed by Lucas L Custodio, V1</footer>
<script type="module">
  import { db, requireAuth, prefixBadgeClass, formatDateBR } from './js/firebase.js';
  import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  await requireAuth();
  const $=(q)=>document.querySelector(q);
  function defaultMonth(){ const d=new Date(); return d.toISOString().slice(0,7); }

  async function load(){
    const [y,m]=$('#mes').value.split('-').map(Number);
    const first=new Date(y, m-1, 1); const last=new Date(y,m,0,23,59,59,999);
    const qy=query(collection(db,'lavagens'), where('createdAt','>=',first), where('createdAt','<=',last));
    const snap=await getDocs(qy);
    const map={};
    snap.forEach(s=>{ const d=s.data(); const p=d.prefixo; const dia=(d.dataRef?.toDate?.()||d.createdAt?.toDate?.()||new Date()); (map[p]=map[p]||{p, qtd:0, dias:[]}).qtd++; map[p].dias.push(formatDateBR(dia)); });
    const arr=Object.values(map).sort((a,b)=>a.p.localeCompare(b.p));
    const tb=$('#tabMensal tbody'); tb.innerHTML='';
    arr.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><span class="badge ${prefixBadgeClass(r.p)}">${r.p}</span></td><td>${r.qtd}</td><td>${[...new Set(r.dias)].join(', ')}</td>`; tb.appendChild(tr); });
    renderChart(arr);
  }
  function renderChart(arr){
    const labels=arr.map(r=>r.p); const data=arr.map(r=>r.qtd);
    if(window._chart) window._chart.destroy();
    window._chart = new Chart(document.getElementById('chart'), {type:'bar', data:{labels, datasets:[{label:'Lavagens no mês', data, borderWidth:1}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
  }
  async function exportPDF(){
    const { jsPDF } = window.jspdf; const el=document.getElementById('mensalBox'); const canvas=await html2canvas(el);
    const pdf=new jsPDF('p','mm','a4'); const w=pdf.internal.pageSize.getWidth(); const h=(canvas.height*w)/canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,w,h); pdf.save('relatorio_mensal.pdf');
  }
  document.getElementById('mes').value=defaultMonth(); load();
  document.getElementById('btnPDF').addEventListener('click', exportPDF);
  document.getElementById('mes').addEventListener('change', load);
  document.getElementById('filtroPrefixo').addEventListener('input', ()=>{
    const txt = document.getElementById('filtroPrefixo').value.trim();
    const rows = Array.from(document.querySelectorAll('#tabMensal tbody tr'));
    rows.forEach(tr=>{ const has = tr.innerText.toLowerCase().includes(txt.toLowerCase()); tr.style.display = has? '':'none'; });
  });
  document.getElementById('btnExcelMensal').addEventListener('click', ()=>{
    const tbl = document.getElementById('tabMensal');
    const wb = XLSX.utils.table_to_book(tbl, {sheet: 'Mensal'});
    XLSX.writeFile(wb, 'relatorio_mensal.xlsx');
  });
  document.getElementById('btnGraficoMensal').addEventListener('click', ()=>{ location.href='monthly_chart.html'; });
</script>
</body>
</html>